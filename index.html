<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒè¦ç‚¹æ–°é—»èšåˆ</title>
    <style>
        /* CSS æ ·å¼ä¿æŒä¸å˜ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f9; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        h1 { color: #333; text-align: center; margin-bottom: 20px; font-size: 1.5em; }
        .tip-bar { background-color: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; font-size: 0.9em; text-align: center; margin-bottom: 20px; border: 1px solid #bbdefb; }
        .controls-section { margin-bottom: 15px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .controls-label { font-size: 0.85em; color: #888; margin-bottom: 10px; font-weight: bold; }
        .controls { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .controls::-webkit-scrollbar { display: none; } 
        .controls button { padding: 6px 14px; border: 1px solid #eee; border-radius: 18px; background-color: #f8f9fa; cursor: pointer; white-space: nowrap; font-size: 13px; color: #555; transition: all 0.2s; }
        .controls.country-group button.active { background-color: #007bff; color: #fff; border-color: #007bff; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
        .controls.category-group button.active { background-color: #28a745; color: #fff; border-color: #28a745; box-shadow: 0 2px 5px rgba(40,167,69,0.3); }
        .news-list { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .news-card { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); display: flex; gap: 15px; text-decoration: none; color: #333; transition: transform 0.2s; }
        .news-card:active { transform: scale(0.98); }
        .news-content { flex-grow: 1; }
        .news-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; line-height: 1.4; }
        .news-meta { font-size: 0.85em; color: #6c757d; margin-top: 5px; display: flex; align-items: center; gap: 5px; flex-wrap: wrap;}
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; background: #eee; }
        .tag-crypto { background: #fff3cd; color: #856404; }
        .tag-business { background: #d1ecf1; color: #0c5460; }
        .tag-tech { background: #d4edda; color: #155724; }
        .news-image { width: 100px; height: 80px; object-fit: cover; border-radius: 4px; flex-shrink: 0; background-color: #eee; }
        .status-message { text-align: center; padding: 50px; color: #666; word-break: break-word; }
    </style>
</head>
<body>

<div class="container">
    <h1>å…¨çƒè¦ç‚¹æ–°é—»èšåˆ</h1>
    
    <div class="tip-bar">
        ğŸ’¡ æç¤ºï¼šç‚¹å‡»æµè§ˆå™¨èœå• <b>"ç¿»è¯‘..."</b> å¯ä¸€é”®æŸ¥çœ‹ä¸­æ–‡æ–°é—»ã€‚
    </div>

    <div class="controls-section">
        <div class="controls-label">1. é€‰æ‹©åœ°åŒº</div>
        <div class="controls country-group" id="country-controls"></div>
    </div>

    <div class="controls-section">
        <div class="controls-label">2. æ–°é—»ç±»åˆ«</div>
        <div class="controls category-group" id="category-controls"></div>
    </div>

    <div class="news-list" id="news-list">
        <p class="status-message">æ­£åœ¨åˆå§‹åŒ–...</p>
    </div>
</div>

<script>
    // =========================================================
    // ğŸ”´ ğŸ”´ ğŸ”´ é…ç½®åŒºåŸŸ ğŸ”´ ğŸ”´ ğŸ”´
    // =========================================================
    
    // ã€å·²ç§»é™¤ API_KEYï¼ŒWorker å°†ä» Secrets ä¸­è·å–æ‰€æœ‰ Keyã€‘
    
    // âš ï¸âš ï¸âš ï¸ è¯·åŠ¡å¿…åœ¨æ­¤å¤„å¡«å…¥æ‚¨çœŸå®çš„ Worker ç½‘å€ï¼
    const BASE_URL = "https://gnews-proxy-worker.pages.dev/"; 

    // =========================================================

    const COUNTRIES = {
        "us": "ğŸ‡ºğŸ‡¸ ç¾å›½", "gb": "ğŸ‡¬ğŸ‡§ è‹±å›½", "cn": "ğŸ‡¨ğŸ‡³ ä¸­å›½", "hk": "ğŸ‡­ğŸ‡° é¦™æ¸¯",
        "jp": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬", "kr": "ğŸ‡°ğŸ‡· éŸ©å›½", "sg": "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡", "in": "ğŸ‡®ğŸ‡³ å°åº¦", "de": "ğŸ‡©ğŸ‡ª å¾·å›½"
    };

    const CATEGORIES = {
        "general": "ğŸ“° ç»¼åˆå¤´æ¡", "business": "ğŸ’° ç»æµé‡‘è", 
        "technology": "ğŸ“± ç§‘æŠ€åˆ›æŠ•", "crypto": "ğŸª™ åŠ å¯†è´§å¸"
    };

    var currentCountry = 'us'; 
    var currentCategory = 'general';

    var newsListEl = document.getElementById('news-list');
    var countryControlsEl = document.getElementById('country-controls');
    var categoryControlsEl = document.getElementById('category-controls');

    // æ ¸å¿ƒè·å–å‡½æ•°
    async function fetchNews() {
        if (BASE_URL.indexOf("yourname") !== -1) {
            newsListEl.innerHTML = '<p class="status-message" style="color: red; font-weight:bold;">é…ç½®é”™è¯¯ï¼<br>è¯·åœ¨ä»£ç ä¸­å¡«å…¥æ‚¨çœŸå®çš„ Cloudflare Worker ç½‘å€ã€‚</p>';
            return;
        }

        var countryName = COUNTRIES[currentCountry];
        var categoryName = CATEGORIES[currentCategory];
        
        newsListEl.innerHTML = '<p class="status-message">æ­£åœ¨æœç´¢ <b>' + countryName + '</b> çš„ <b>' + categoryName + '</b>...</p>';
        
        try {
            // ã€æ ¸å¿ƒå˜åŒ–ã€‘ï¼šä¸å†ä¼ é€’ token å‚æ•°
            var url = BASE_URL + '?country=' + currentCountry;
            
            // ä¼ é€’åˆ†ç±»ä¿¡æ¯
            if (currentCategory === 'business') { url += '&topic=business'; } 
            else if (currentCategory === 'technology') { url += '&topic=technology'; } 
            else if (currentCategory === 'crypto') { url += '&q=crypto'; }

            var response = await fetch(url);

            // å¤„ç† HTTP é”™è¯¯
            if (!response.ok) {
                 var errorMessage = 'ä»£ç†è®¿é—®å¤±è´¥ (' + response.status + ')';
                 try {
                     var errorData = await response.json();
                     if (errorData.errors && errorData.errors.length > 0) {
                         if (typeof errorData.errors[0] === 'string') {
                             errorMessage = errorData.errors[0]; 
                         } else if (errorData.errors[0].message) {
                             errorMessage = errorData.errors[0].message; 
                         }
                     }
                 } catch (e) { } 
                 
                 newsListEl.innerHTML = '<p class="status-message" style="color: red;">' + errorMessage + '</p>';
                 return;
            }

            var data = await response.json();

            // å…¼å®¹ API è¿”å›çš„ articles ç»“æ„
            if (data.articles && data.articles.length > 0) {
                renderNews(data.articles);
            } else {
                if (data.status === 'error' && data.message) {
                    newsListEl.innerHTML = '<p class="status-message" style="color: red;">API é”™è¯¯: ' + data.message + '</p>';
                    return;
                }
                newsListEl.innerHTML = '<p class="status-message">è¯¥åˆ†ç±»ä¸‹æš‚æ—¶æ²¡æœ‰æ–°é—»ã€‚<br>è¯·å°è¯•åˆ‡æ¢åˆ°â€œç¾å›½â€æˆ–â€œè‹±å›½â€æºã€‚</p>';
            }

        } catch (error) {
            console.error("Fetch Error:", error);
            newsListEl.innerHTML = '<p class="status-message" style="color: red;">ç½‘ç»œè¿æ¥å¤±è´¥ã€‚<br>è¯·æ£€æŸ¥ç½‘å€æ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•åˆ·æ–°é¡µé¢ã€‚</p>';
        }
    }

    function renderNews(articles) {
        newsListEl.innerHTML = ''; 
        articles.forEach(function(article) {
            if (!article.title || !article.url) return;
            var card = document.createElement('a');
            card.className = 'news-card';
            card.href = article.url;
            card.target = '_blank';
            
            var dateStr = new Date(article.publishedAt).toLocaleDateString();

            var tagHtml = '';
            if (currentCategory === 'crypto') tagHtml = '<span class="tag tag-crypto">Crypto</span>';
            if (currentCategory === 'business') tagHtml = '<span class="tag tag-business">Biz</span>';
            if (currentCategory === 'technology') tagHtml = '<span class="tag tag-tech">Tech</span>';

            var imgHtml = '';
            var imageUrl = article.image || article.urlToImage;
            if (imageUrl) {
                imgHtml = '<img src="' + imageUrl + '" class="news-image" loading="lazy">';
            }

            var sourceName = article.source.name || 'æœªçŸ¥æ¥æº';

            card.innerHTML = 
                '<div class="news-content">' +
                    '<div class="news-title">' + article.title + '</div>' +
                    '<div class="news-meta">' +
                        tagHtml +
                        '<span>' + sourceName + '</span>' +
                        '<span>Â· ' + dateStr + '</span>' +
                    '</div>' +
                '</div>' + imgHtml;
            
            newsListEl.appendChild(card);
        });
    }

    function setupControls() {
        // å›½å®¶æŒ‰é’®
        Object.keys(COUNTRIES).forEach(function(code) {
            var button = document.createElement('button');
            button.textContent = COUNTRIES[code];
            if (code === currentCountry) button.classList.add('active');
            
            button.onclick = function() {
                var btns = document.querySelectorAll('.country-group button');
                for(var i=0; i<btns.length; i++) btns[i].classList.remove('active');
                button.classList.add('active');
                currentCountry = code;
                fetchNews();
            };
            countryControlsEl.appendChild(button);
        });

        // åˆ†ç±»æŒ‰é’®
        Object.keys(CATEGORIES).forEach(function(cat) {
            var button = document.createElement('button');
            button.textContent = CATEGORIES[cat];
            if (cat === currentCategory) button.classList.add('active');
            
            button.onclick = function() {
                var btns = document.querySelectorAll('.category-group button');
                for(var i=0; i<btns.length; i++) btns[i].classList.remove('active');
                button.classList.add('active');
                currentCategory = cat;
                fetchNews();
            };
            categoryControlsEl.appendChild(button);
        });
    }

    // å¯åŠ¨
    setupControls();
    fetchNews();
</script>
</body>
</html>